<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Products Management - AZ TMA</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="header" style="display: flex; align-items: center; justify-content: space-between; padding: 15px 30px;">
    <div style="display: flex; align-items: center; gap: 15px;">
      <img src="./assets/logo.png" alt="AZ TMA Logo" style="height: 50px; width: auto; border-radius: 5px;">
      <h1 style="font-size: 1.5rem; margin: 0;"></i> AZ TMA  </h1>
    </div>
    <p style="font-size: 0.9rem; margin: 0; opacity: 0.9;">  Product API & UI using SAP CAP & SAP UI5</p>
  </nav>

  <div class="container">
    <div class="main-content" style="margin-top: 20px;">
      <div id="status" class="status"></div>


      <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: var(--shadow-lg); max-width: 400px; width: 90%;">
          <h3 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fas fa-edit"></i> Edit Product</h3>
          <div class="form-group" style="flex-direction: column;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Product Name</label>
            <input type="text" id="modalName" placeholder="Product name" style="width: 100%;">
          </div>
          <div class="form-group" style="flex-direction: column;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Category</label>
            <select id="modalCategory" style="width: 100%;">
              <option value="drinks">Drinks</option>
              <option value="grocery">Grocery</option>
            </select>
          </div>
          <div class="form-group" style="gap: 10px; margin-top: 20px;">
            <button onclick="saveEdit()" style="flex: 1;"><i class="fas fa-save"></i> Save</button>
            <button onclick="closeModal()" class="secondary" style="flex: 1;"><i class="fas fa-times"></i> Cancel</button>
          </div>
        </div>
      </div>

      <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap;">
          <h2 style="margin: 0;"><i class="fas fa-table"></i> Products List</h2>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="text" id="searchInput" placeholder="ðŸ” Search..." onkeyup="searchProducts()" style="min-width: 150px; padding: 8px 12px;">
            <select id="filterCategory" onchange="filterProducts()" style="padding: 8px 12px;">
              <option value="">All</option>
              <option value="drinks"> Drinks</option>
              <option value="grocery"> Grocery</option>
            </select>
            <button onclick="refreshTable()" class="secondary" style="padding: 8px 12px; font-size: 12px;"><i class="fas fa-sync"></i></button>
            <button onclick="openCreateModal()" style="padding: 8px 12px; font-size: 12px;"><i class="fas fa-plus"></i> New</button>
          </div>
        </div>
        <table id="productsTable">
          <thead>
            <tr>
              <th>Product Name</th>
              <th style="width: 120px;">Category</th>
              <th>Created</th>
              <th>Updated</th>
              <th style="width: 200px;">Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="5">
                <div class="empty-state">
                  <i class="fas fa-spinner fa-spin"></i>
                  <p>Loading products...</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="createModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: var(--shadow-lg); max-width: 400px; width: 90%;">
          <h3 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fas fa-plus-circle"></i> Create New Product</h3>
          <div class="form-group" style="flex-direction: column;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Product Name</label>
            <input type="text" id="modalCreateName" placeholder="Enter product name" style="width: 100%;">
          </div>
          <div class="form-group" style="flex-direction: column;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Category</label>
            <select id="modalCreateCategory" style="width: 100%;">
              <option value="drinks">Drinks</option>
              <option value="grocery">Grocery</option>
            </select>
          </div>
          <div class="form-group" style="gap: 10px; margin-top: 20px;">
            <button onclick="saveCreate()" style="flex: 1;"><i class="fas fa-plus"></i> Create</button>
            <button onclick="closeCreateModal()" class="secondary" style="flex: 1;"><i class="fas fa-times"></i> Cancel</button>
          </div>
        </div>
      </div>

     
      <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: var(--shadow-lg); max-width: 400px; width: 90%;">
          <h3 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fas fa-edit"></i> Edit Product</h3>
          <div class="form-group" style="flex-direction: column;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Product Name</label>
            <input type="text" id="modalName" placeholder="Product name" style="width: 100%;">
          </div>
          <div class="form-group" style="flex-direction: column;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Category</label>
            <select id="modalCategory" style="width: 100%;">
              <option value="drinks">Drinks</option>
              <option value="grocery">Grocery</option>
            </select>
          </div>
          <div class="form-group" style="gap: 10px; margin-top: 20px;">
            <button onclick="saveEdit()" style="flex: 1;"><i class="fas fa-save"></i> Save</button>
            <button onclick="closeModal()" class="secondary" style="flex: 1;"><i class="fas fa-times"></i> Cancel</button>
          </div>
        </div>
      </div>

      <!-- Modal de confirmation de suppression -->
      <div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 90%; text-align: center;">
          <div style="width: 80px; height: 80px; border: 4px solid #f8bb86; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-exclamation" style="font-size: 40px; color: #f8bb86;"></i>
          </div>
          <h2 style="margin-bottom: 10px; color: #595959; font-size: 1.8rem;">Are you sure?</h2>
          <p id="deleteMessage" style="color: #999; margin-bottom: 25px; font-size: 1.1rem;">You won't be able to revert this!</p>
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="confirmDelete()" style="background: #3085d6; padding: 12px 24px; font-size: 14px; border-radius: 5px; color: white; border: none; cursor: pointer;">
              Yes, delete it!
            </button>
            <button onclick="closeDeleteModal()" style="background: #d33; padding: 12px 24px; font-size: 14px; border-radius: 5px; color: white; border: none; cursor: pointer;">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/odata/v4';
    let selectedProduct = null;
    let editingProduct = null;
    let allProducts = [];

    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      const icons = {
        info: 'fas fa-info-circle',
        error: 'fas fa-exclamation-circle',
        success: 'fas fa-check-circle'
      };
      status.innerHTML = `<i class="${icons[type]}"></i><span>${message}</span>`;
      status.className = `status show ${type}`;
      setTimeout(() => status.classList.remove('show'), 4000);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'short', day: 'numeric' }) + ' ' +
             date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }

    async function loadProducts() {
      try {
        const response = await fetch(`${API_URL}/Products?$select=ID,name,category,creation_date,updated_date&$top=100`);
        if (!response.ok) throw new Error('Failed to load');
        const data = await response.json();
        allProducts = data.value || [];
        displayProducts(allProducts);
      } catch (error) {
        console.error('Error:', error);
        showStatus('Error loading products', 'error');
      }
    }

    function displayProducts(products) {
      const tbody = document.getElementById('tableBody');
      if (!products || products.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No products found</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = products.map(product => `
        <tr>
          <td><strong>${product.name}</strong></td>
          <td><span class="category-badge ${product.category}">${product.category}</span></td>
          <td><span class="date-text">${formatDate(product.creation_date)}</span></td>
          <td><span class="date-text">${formatDate(product.updated_date)}</span></td>
          <td>
            <div class="action-buttons" style="justify-content: flex-start; gap: 4px;">
              <button onclick="openEditModal('${product.ID}', '${product.name.replace(/'/g, "\\'")}', '${product.category}')" style="background: #17a2b8; padding: 6px 10px; font-size: 12px;">
                <i class="fas fa-pencil-alt"></i> Edit
              </button>
              <button onclick="deleteProductInline('${product.ID}', '${product.name.replace(/'/g, "\\'")}', '${product.category}')" style="background: #dc3545; padding: 6px 10px; font-size: 12px;">
                <i class="fas fa-trash-alt"></i> Delete
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function openEditModal(id, name, category) {
      editingProduct = { id, name, category };
      document.getElementById('modalName').value = name;
      document.getElementById('modalCategory').value = category;
      document.getElementById('editModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
      editingProduct = null;
    }

    function openCreateModal() {
      document.getElementById('modalCreateName').value = '';
      document.getElementById('modalCreateCategory').value = 'drinks';
      document.getElementById('createModal').style.display = 'flex';
    }

    function closeCreateModal() {
      document.getElementById('createModal').style.display = 'none';
    }

    async function saveCreate() {
      const name = document.getElementById('modalCreateName').value.trim();
      const category = document.getElementById('modalCreateCategory').value;

      if (!name) {
        showStatus('âŒ Product name is required', 'error');
        return;
      }

      if (!/^[a-zA-Z0-9\s]+$/.test(name)) {
        showStatus('âŒ Product name can only contain letters, numbers, and spaces', 'error');
        return;
      }

      if (/^\d+$/.test(name)) {
        showStatus('âŒ Product name cannot be only numbers', 'error');
        return;
      }

      if (name.length > 100) {
        showStatus('âŒ Product name must not exceed 100 characters', 'error');
        return;
      }

      const duplicate = allProducts.find(p => p.name.toLowerCase() === name.toLowerCase());
      if (duplicate) {
        showStatus('âŒ A product with this name already exists', 'error');
        return;
      }

      try {
        showStatus('Creating product...', 'info');
        const response = await fetch(`${API_URL}/Products`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, category })
        });
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error?.message || 'Create failed');
        }
        showStatus('âœ¨ Product created successfully!', 'success');
        closeCreateModal();
        loadProducts();
      } catch (error) {
        console.error('Error:', error);
        showStatus(`âŒ ${error.message}`, 'error');
      }
    }

    async function saveEdit() {
      if (!editingProduct) return;

      const name = document.getElementById('modalName').value.trim();
      const category = document.getElementById('modalCategory').value;

      if (!name) {
        showStatus('âŒ Product name is required', 'error');
        return;
      }

      if (!/^[a-zA-Z0-9\s]+$/.test(name)) {
        showStatus('âŒ Product name can only contain letters, numbers, and spaces', 'error');
        return;
      }

      if (/^\d+$/.test(name)) {
        showStatus('âŒ Product name cannot be only numbers', 'error');
        return;
      }

      if (name.length > 100) {
        showStatus('âŒ Product name must not exceed 100 characters', 'error');
        return;
      }

      const duplicate = allProducts.find(p => p.name.toLowerCase() === name.toLowerCase() && p.ID !== editingProduct.id);
      if (duplicate) {
        showStatus('âŒ A product with this name already exists', 'error');
        return;
      }

      try {
        showStatus('Updating product...', 'info');
        const response = await fetch(`${API_URL}/Products('${editingProduct.id}')`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, category })
        });
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error?.message || 'Update failed');
        }
        showStatus('âœ… Product updated successfully!', 'success');
        closeModal();
        loadProducts();
      } catch (error) {
        console.error('Error:', error);
        showStatus(`âŒ ${error.message}`, 'error');
      }
    }

    let deleteProductId = null;
    let deleteProductName = null;

    function deleteProductInline(id, name, category) {
      deleteProductId = id;
      deleteProductName = name;
      document.getElementById('deleteMessage').textContent = `You are about to delete "${name}". This cannot be undone!`;
      document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
      deleteProductId = null;
      deleteProductName = null;
    }

    async function confirmDelete() {
      if (!deleteProductId) return;
      const id = deleteProductId;
      closeDeleteModal();

      try {
        showStatus('Deleting product...', 'info');
        const response = await fetch(`${API_URL}/Products('${id}')`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        if (!response.ok) {
          const error = await response.text();
          console.error('Server response:', error);
          throw new Error(`Delete failed: ${response.status}`);
        }
        showStatus('Product deleted successfully! ðŸ—‘ï¸', 'success');
        loadProducts();
      } catch (error) {
        console.error('Error:', error);
        showStatus('Error deleting product', 'error');
      }
    }

 
    function selectProduct(id, name, category) {
      selectedProduct = { id, name, category };
    }

    function selectAndEdit(id, name, category) {
      selectedProduct = { id, name, category };
      document.getElementById('updateName').value = name;
      document.getElementById('updateCategory').value = category;
      const radios = document.querySelectorAll('input[name="productSelect"]');
      radios.forEach(r => r.checked = r.value === id);
    }

    function searchProducts() {
      const query = document.getElementById('searchInput').value.trim().toLowerCase();
      displayProducts(allProducts.filter(p => p.name.toLowerCase().includes(query)));
    }

    function filterProducts() {
      const category = document.getElementById('filterCategory').value;
      if (category === '') {
        displayProducts(allProducts);
      } else {
        displayProducts(allProducts.filter(p => p.category === category));
      }
    }

    function refreshTable() {
      showStatus('Refreshing data...', 'info');
      loadProducts();
    }

    
    document.addEventListener('DOMContentLoaded', function() {
      const editModal = document.getElementById('editModal');
      const createModal = document.getElementById('createModal');
      
      if (editModal) {
        editModal.addEventListener('click', function(e) {
          if (e.target === editModal) closeModal();
        });
      }
      
      if (createModal) {
        createModal.addEventListener('click', function(e) {
          if (e.target === createModal) closeCreateModal();
        });
      }
      
      loadProducts();
    });

   
    loadProducts();
  </script>
</body>
</html>
